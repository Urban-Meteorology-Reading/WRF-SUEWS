.. _quickstart:

Quick Start
============



Installation
-----------------

Download source code
~~~~~~~~~~~~~~~~~~~~

Clone WRF-SUEWS repository::

    git clone git@github.com:Urban-Meteorology-Reading/WRF-SUEWS.git


After cloning the repo, make sure you use the following commands to update SUEWS repo associated with WRF-SUEWS ::

    git submodule init
    git submodule update


.. note:: An older version of SUEWS (v2018c) is used in this coupling work; the most up-to-date SUEWS is v2020a.


Couple WRF and SUEWS
~~~~~~~~~~~~~~~~~~~~~

Suppose you are in the root location of ``WRF-SUEWS`` directory, run the following code to set up a workspace folder for the coupled code (a folder named ``WRF-SUEWS`` by default; `the name can be customised <https://github.com/Urban-Meteorology-Reading/WRF-SUEWS/blob/50dba67f3a66cfee296d7c4de88d3f52353b13cd/coupling-automator/automate_main.py#L57>`)::

    # go to the coupler directory
    cd coupling-automator

    # run the coupler
    make

Compile WRF-SUEWS
~~~~~~~~~~~~~~~~~~~~~

Then go into the workspace folder (``WRF-SUEWS`` if not set otherwise) and configure the compilation, which is now same as the standard WRF workflow::

    ./configure

Compile the code as follows::

    ./compile em_real >& compile.log


.. note:: If working on `jasmin`, you can also submit the job as following:


    .. unclear: what is this file?

    .. code-block:: bash

        #!/bin/bash
        #BSUB -q short-serial
        #BSUB -o %J.out
        #BSUB -e %J.err
        #BSUB -W 02:30

        ./compile em_real >& log.compile

Pre-processing
----------------------------------

The WRF-SUEWS pre-processing consists of two steps:

Standard WPS pre-processing
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To generate the standard `wrfinput` files, please follow `the official tutorial`_.
Once `wrfinput` (initial conditions) and `wrfbdy` (boundary conditions) files are generated by WPS, please further modify `wrfinput` using WRF-SUEWS pre-processor (WSPS) described as follows.

.. _the official tutorial: https://www2.mmm.ucar.edu/wrf/OnLineTutorial/CASES/JAN00/index.php

SUEWS-specific pre-processing
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

We strongly recommend `Anaconda-based python environment <https://www.anaconda.com/products/individual>`_ for running WSPS.

After Anaconda is installed, please use ``conda`` to create a fresh environment named ``WRF_SUEWS_pre`` for WSPS::

    cd input-processor/pre-processor-UK
    conda env create -f environment.yml

.. TODO #84

Then switch to new environment and run WSPS::

    conda activate WRF_SUEWS_pre
    python3 wsps.py

.. note:: Please change the settings in ``wsps.py`` if necessary following instructions in :ref:`wsps`.

.. double-check the name of output directory. #84

After running WSPS, WRF-SUEWS specific `wrfinput` netCDF files (e.g., ``wrfinput_d03.suews``) will be generated under ``output``.



Simulation
------------------------------------
run simulation

1- After compilation of the code and pre-processing steps to prepare `wrf_input` files, you need to transfer all the `wrf_input` files to the location of main run (usually `[WRF-SUEWS directory]/test/em_real`). It should include the boundary condition file.

2- You also need to copy `namelist.suews` to the same location.

3- Use `LANDUSE.TBL` in `./test/em_real` to change the albedo associated with Urban areas (number `13` for `MODIFIED_IGBP_MODIS_NOAH` for both winter and summer. By default it is 15% (0.15). In London case, it is changed to 11%(0.11) based on Ward et al. 2016)

4- `namelist.input` should also be modified to be consistent for WRF-SUEWS. See examples [here](https://github.com/Urban-Meteorology-Reading/WRF-SUEWS/tree/master/input-processor/namelist_example/UK) (specially the `sf_surface_physics = 9` which specifies to use SUEWS as the LSM).

5- Finally, use the following script to run the simulations on JASMIN (go to [WRF-SUEWS directory]/test/em_real):

```
#!/bin/bash
#BSUB -q par-multi
#BSUB -n 30
#BSUB -o %J.out
#BSUB -e %J.err
#BSUB -W 48:00

echo "Running WRF"
mpirun ./wrf.exe
```


Post-processing
----------------------------------

.. what are the SUEWS specific variables
